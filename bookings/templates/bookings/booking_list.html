{% extends "base.html" %}
{% block title %}Booking Requests{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="mb-3">Booking Requests</h1>

  {# -------- NON-STAFF: show outbound requests they sent -------- #}
  {% if not user.is_staff and not user.is_superuser %}
    <h2 class="h4">Your Booking Requests</h2>

    {% if requests_qs %}
      <div class="table-responsive mb-4">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Subject</th>
              <th>Sent</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for m in requests_qs %}
              <tr>
                <td>{{ m.subject }}</td>
                <td>{{ m.sent_at|date:"Y-m-d H:i" }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-secondary" href="{% url 'glamp_messaging:view_message' m.pk %}">
                    View
                  </a>
                  <a class="btn btn-sm btn-outline-danger" href="{% url 'glamp_messaging:delete_message' m.pk %}">
                    Cancel
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="mb-4">You havenâ€™t sent any booking requests yet.</p>
    {% endif %}
  {% endif %}

  {# -------- STAFF/ADMINS: show incoming requests only -------- #}
  {% if user.is_staff or user.is_superuser %}
    <h2 class="h4 mt-4">Incoming Booking Requests</h2>

    {% if incoming_qs %}
      <div class="table-responsive mb-3">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>From</th>
              <th>Subject</th>
              <th>Sent</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for m in incoming_qs %}
              <tr>
                <td>
                  {% if m.sender.full_name %}{{ m.sender.full_name }}{% else %}{{ m.sender.email }}{% endif %}
                </td>
                <td>{{ m.subject }}</td>
                <td>{{ m.sent_at|date:"Y-m-d H:i" }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-secondary" href="{% url 'glamp_messaging:view_message' m.pk %}">
                    View
                  </a>
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'glamp_messaging:reply_message' m.pk %}">
                    Reply
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="mb-4">No incoming booking requests.</p>
    {% endif %}
  {% endif %}

  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'bookings:accommodation_list' %}">Browse accommodations</a>
  </div>
</div>
{% endblock %}
