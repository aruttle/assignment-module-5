{% extends "base.html" %}
{% block title %}Request a Booking{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="mb-3">Request a Booking</h1>

  {% if accommodation %}
    <div class="alert alert-info d-flex justify-content-between align-items-center">
      <div>
        <strong>Accommodation:</strong> {{ accommodation.name }}
      </div>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'bookings:booking_request' %}">
        Change
      </a>
    </div>
  {% endif %}

  <form method="post" novalidate>
    {% csrf_token %}
    {{ form.non_field_errors }}

    {# carry accommodation id in POST if present #}
    {% if accommodation %}
      <input type="hidden" name="accommodation_id" value="{{ accommodation.id }}">
    {% endif %}

    <div class="row g-3">
      <div class="col-md-6">
        <label for="{{ form.start_date.id_for_label }}" class="form-label">Check-in</label>
        {{ form.start_date }}
        {% if form.start_date.errors %}<div class="text-danger small mt-1">{{ form.start_date.errors }}</div>{% endif %}
      </div>
      <div class="col-md-6">
        <label for="{{ form.end_date.id_for_label }}" class="form-label">Check-out</label>
        {{ form.end_date }}
        {% if form.end_date.errors %}<div class="text-danger small mt-1">{{ form.end_date.errors }}</div>{% endif %}
      </div>

      <div class="col-md-6">
        <label for="{{ form.guests.id_for_label }}" class="form-label">Guests</label>
        {{ form.guests }}
        {% if form.guests.errors %}<div class="text-danger small mt-1">{{ form.guests.errors }}</div>{% endif %}
      </div>

      <div class="col-12">
        <label for="{{ form.notes.id_for_label }}" class="form-label">Notes (optional)</label>
        {{ form.notes }}
        {% if form.notes.errors %}<div class="text-danger small mt-1">{{ form.notes.errors }}</div>{% endif %}
      </div>
    </div>

    <div class="d-flex gap-2 mt-4">
      <button type="submit" class="btn btn-primary">Send request</button>
      <a href="{% url 'bookings:booking_list' %}" class="btn btn-secondary">Cancel</a>
    </div>
  </form>
</div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  if (window.flatpickr) {
    const fmt = { dateFormat: 'Y-m-d', allowInput: true };
    const start = document.getElementById('id_start_date');
    const end = document.getElementById('id_end_date');

    // Booked ranges from server (if tied to an accommodation)
    const disabledRanges = {{ booked_ranges_json|default:"[]"|safe }};
    const todayStr = "{{ today_str|default:'' }}";

    function normalizeRanges(ranges) {
      // flatpickr supports objects: {from: 'YYYY-MM-DD', to: 'YYYY-MM-DD'}
      return Array.isArray(ranges) ? ranges.map(r => ({from: r.from, to: r.to})) : [];
    }

    if (start) {
      window.flatpickr(start, Object.assign({}, fmt, {
        minDate: todayStr || null,
        disable: normalizeRanges(disabledRanges),
        onChange: function(selectedDates) {
          if (end && selectedDates && selectedDates[0]) {
            if (end._flatpickr) {
              end._flatpickr.set('minDate', selectedDates[0]);
            }
          }
        }
      }));
    }
    if (end) {
      window.flatpickr(end, Object.assign({}, fmt, {
        minDate: todayStr || null,
        disable: normalizeRanges(disabledRanges),
      }));
    }
  }
});
</script>
{% endblock %}
